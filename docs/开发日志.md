# RacerStats 开发日志

## 项目简介
RacerStats 致力于构建一款赛道计时与分析 App，可在智能终端上完成赛道收集、起终点配置、实时圈速预测与 Delta 对比，帮助车手在赛道练习中即时掌握当前表现，并沉淀可靠的历史数据。

## 功能进度
### 已完成
- [x] 建立应用主结构与 ViewPager2 导航，接入 Live/Track/Review 三大功能区。
- [x] 实现 `LapManager` 核心圈速逻辑、Delta 与预测算法，并在 HUD 中实时展示。
- [x] 引入速度平滑、动态超时与指数衰减，完成 Vmax 峰值记录及手动清零能力。
- [x] 搭建赛道数据模型、Room 持久层与 `TrackFragment` 地图录制骨架。
- [x] 完成 Hilt 依赖注入、Compose 运行时配置及 Google Maps API Key 适配。

### 待办
- [ ] 打通赛道录制 → `TrackManager.saveTrack` → 列表/详情刷新闭环。
- [ ] LapManager 与赛道起终点联动，实现自动识别过线与圈速持久化。
- [ ] 丰富 HUD：圈数/最佳圈展示、速度衰减动画与 Vmax 详情弹窗。
- [ ] 扩展速度算法：区分 Dragy/GNSS 参数、引入最小可靠速度阈值。
- [ ] 建立调试面板、单元测试与真机回归流程，完善数据导出与设置页。

---

## 2025 年 11 月 4 日

### 已完成
- 初始化项目骨架：`MainActivity` + ViewPager2 导航，Live/Track/Review 三个分区。
- 构建计时核心 `LapManager`，支持起圈、更新、完圈、Delta 与预测；`LiveFragment` 实时显示速度、Delta、预计完赛时间，并提供 350 km/h HUD 进度条。
- 梳理赛道管理规划，明确 `TrackManager`、`TrackRecorder`、`TrackMatcher`、`TrackViewModel` 等职责并完成初版接口设计。

### 技术细节
- `LapManager` 关键方法：`startNewLap`、`updateCurrentLap`、`completeLap`、`calculateDelta`、`predictTotalTime`、`getBestLapTime`；对应数据结构 `LapData`、`CheckpointData`。
- 速度平滑策略：`smoothed = old * 0.7 + new * 0.3`，用于缓解 GPS 抖动并保持响应速度。
- 核心文件布局：`LiveFragment` 负责实时 HUD，timing 模块封装计时逻辑，`activity_main.xml` 提供 HUD 容器与进度条。

### 待办
- HUD：补齐圈数、最佳圈、Delta 动效并优化布局。
- 计时深化：完善起终点检测、分段计时、数据持久化与统计分析。
- 系统功能：数据导出、设置页（起终点/间隔/单位）、轨迹记录/回放。
- 性能：采样率管理、速度算法优化、内存与功耗控制。

### 备注
- 数据类按需改为 `var` 以支持实时更新。
- 赛道后续功能需与现有 HUD/计时接口解耦，保持扩展空间。

---

## 2025 年 11 月 5 日

### 已完成
- 搭建赛道管理架构：实现 `Track/TrackPoint/TrackLine` 模型、Room `TrackDao`、`TrackManager`、`TrackRecorder`、`TrackViewModel`、`TrackMatcher`。
- 赛道界面骨架：`TrackFragment` 集成地图、起终点线设置与录制控制，补齐 Google Maps 事件流程。
- 依赖与注入：`MainActivity` 添加 `@AndroidEntryPoint`；引入 `implementation(libs.androidx.compose.runtime)` 解决 Compose 运行时缺失。
- 资源补充：新增 `ic_file`/`ic_check`/`ic_close`/`ic_info` 图标与赛道信息字符串，完善 HUD 与赛道文案。
- Manifest 配置：`AndroidManifest.xml` 中加入 `com.google.android.geo.API_KEY` meta-data；`strings.xml` 添加 `google_maps_key` 占位。

### 待办
- 赛道闭环：轨迹录制 → `TrackManager.saveTrack` → 列表刷新；完善 Track 详情/编辑/空态/ Snackbar 反馈。
- 赛道匹配增强：优化轨迹简化、相似度计算、方向性判断与部分匹配策略。
- 计时联动：LapManager 接入赛道起终点，实现自动过线与圈速持久化。
- 权限与部署：完善定位/蓝牙权限流程，真机验证地图，管理 Google Maps API Key。
- 性能与测试：优化地图绘制、轨迹简化、数据库查询，并补齐单元测试与真机回归。

### 备注
- 轨迹匹配候选方案：Douglas-Peucker 简化 + Hausdorff 距离。
- UI 需兼顾夜间模式与多尺寸屏幕；目标 GPS 采样率 10 Hz，关注电量影响。

---

## 2025 年 11 月 7 日

### 已完成
- 调整 `LiveFragment` 生命周期：应用启动仅建立 GNSS/Dragy 连接，计时需手动点击“开始”，暂停/继续/结束时正确回收回调。
- 扩展速度 HUD：新增 Vmax 区域并支持点击清零，速度文本/进度条布局重排。
- 优化速度算法：基于最近五次间隔推断采样周期，断流时执行指数衰减，消除 0 ↔ 97 km/h 闪跳。
- 重构 GPS 监听：统一由 `updateSpeedDisplay` 管理文本与进度条状态，暂停/超时/重置时表现一致。

### 技术说明
1. `LocationManager` 将 Dragy/GNSS 的 `Location` 转换为 `LocationData`，当原始 `speed` 为 0 时以距离/时间补偿。 
2. 速度平滑继续采用 0.7/0.3 权重，并通过 `lastLocationTimestamp` 推断采样周期。 
3. 动态超时：记录有效间隔，连续缺包 5 次触发超时并启动 `speedDecayRunnable`，每 200 ms 以 0.8 衰减直至 0.3 m/s。 
4. Vmax 维护：当速度超过峰值即更新 `vmaxKmh`，点击容器调用 `resetVmax()` 清零并提示。 
5. 权限管理：`ensureLocationTracking()` 统一检查定位/蓝牙权限，避免重复注册 GNSS 回调。

### 待办
- 区分 Dragy 与手机 GPS 的滤波参数，引入最小可靠速度阈值与 UI 提示。
- 为 Vmax 记录峰值时间/坐标，支持长按查看并评估持久化方案。
- 将速度衰减与 HUD 进度条动画联动，推进 LapManager 与赛道起终点整合。
- 构建可切换的调试面板记录速度/衰减/超时事件，并评估 Handler 场景的测试策略。

---

## 2025 年 11 月 12 日

### 已完成
- **赛道宽容度调节功能**：实现了用户可配置的轨迹匹配精度调节，在录制界面增加宽容度选择按钮。
- **UI 布局重构**：将 `fragment_track.xml` 统计信息区域从垂直布局改为水平布局，添加宽容度控制按钮。
- **宽容度预设选项**：提供四种场景化预设 - 精密赛道(25m)、街道赛道(40m)、一般道路(50m)、高速公路(80m)。
- **状态管理**：在 `TrackViewModel` 中添加宽容度状态流管理，支持实时更新和持久化。
- **用户交互**：实现单选对话框选择宽容度，按钮实时显示当前设置，选择后立即生效。

### 技术细节

#### 数据结构与状态管理
```kotlin
// TrackViewModel.kt - 宽容度状态管理
private val _currentTolerance = MutableStateFlow(TrackMatcher.THRESHOLD_STREET_CIRCUIT)
val currentTolerance = _currentTolerance.asStateFlow()

fun getCurrentTolerance(): Double = _currentTolerance.value
fun setTolerance(tolerance: Double) { _currentTolerance.value = tolerance }
```

#### UI 组件结构
```xml
<!-- fragment_track.xml - 水平统计容器 -->
<LinearLayout android:id="@+id/statsContainer"
    android:orientation="horizontal">
    <TextView android:id="@+id/tvDistance" />
    <TextView android:id="@+id/tvPointCount" />
    <Button android:id="@+id/btnTolerance" />
</LinearLayout>
```

#### 宽容度配置方法
```kotlin
// TrackFragment.kt - 宽容度选择对话框
private fun showToleranceSelectionDialog() {
    val toleranceOptions = arrayOf(
        "Precision Track (25m)",  // TrackMatcher.THRESHOLD_PRECISION_TRACK
        "Street Circuit (40m)",   // TrackMatcher.THRESHOLD_STREET_CIRCUIT  
        "General Road (50m)",     // TrackMatcher.THRESHOLD_GENERAL_ROAD
        "Highway (80m)"          // TrackMatcher.THRESHOLD_HIGHWAY
    )
    // AlertDialog 单选实现
}

private fun updateToleranceButton(name: String, tolerance: Double) {
    val shortName = when {
        tolerance <= 25.0 -> "Precision (${tolerance.toInt()}m)"
        tolerance <= 40.0 -> "Street (${tolerance.toInt()}m)" 
        tolerance <= 50.0 -> "Road (${tolerance.toInt()}m)"
        else -> "Highway (${tolerance.toInt()}m)"
    }
    binding.btnTolerance.text = shortName
}
```

#### TrackMatcher 集成
- 使用现有的 `TrackMatcher` 常量系统：`THRESHOLD_PRECISION_TRACK`、`THRESHOLD_STREET_CIRCUIT`、`THRESHOLD_GENERAL_ROAD`、`THRESHOLD_HIGHWAY`
- 宽容度设置直接影响 `calculateSimilarity()` 方法的距离阈值判断
- 支持轨迹匹配时的动态精度调整，适应不同驾驶环境

#### 宽容度配置策略
1. **Precision Track (25m)**：F1赛道、专业卡丁车场，GPS精度要求极高的场景
2. **Street Circuit (40m)**：城市街道赛道、临时封闭路段，平衡精度与容错性（默认选择）
3. **General Road (50m)**：乡村公路、山路，一般户外驾驶环境
4. **Highway (80m)**：高速公路、宽阔直道，GPS信号可能不稳定的高速场景

### 文件修改记录
- `app/src/main/res/layout/fragment_track.xml`：重构统计信息布局，添加宽容度按钮
- `app/src/main/java/com/example/racerstats/track/TrackFragment.kt`：实现宽容度选择对话框和按钮更新逻辑
- `app/src/main/java/com/example/racerstats/track/TrackViewModel.kt`：添加宽容度状态管理方法
- `docs/宽容度调节功能.md`：功能使用说明文档
- `docs/宽容度功能实现总结.md`：技术实现总结文档

### 质量保证
- ✅ Gradle 构建成功，无编译错误
- ✅ 处理 Kotlin 未使用参数警告：`@Suppress("UNUSED_PARAMETER")`
- ✅ 与现有 TrackMatcher 系统完全兼容
- ✅ StateFlow 状态管理符合 MVVM 架构规范

### 用户体验
- 录制界面布局：`[距离: 0.00km] [点数: 0] [Street (40m)]`
- 一键切换宽容度，选择后按钮文字立即更新
- 四种预设覆盖主要使用场景，降低用户学习成本
- 默认街道赛道模式，适合大多数日常使用

### 待办
- [ ] 宽容度设置持久化存储（SharedPreferences）
- [ ] 智能宽容度推荐（基于GPS精度自动建议）
- [ ] 录制过程中显示当前使用的宽容度
- [ ] 不同赛道的宽容度历史记录
- [ ] 自定义宽容度数值输入功能
- [ ] 批量更新已有赛道的宽容度设置

### 技术积累
- **StateFlow 状态管理**：在 ViewModel 中管理 UI 状态的最佳实践
- **AlertDialog 定制**：单选列表对话框的标准实现方式  
- **Layout 重构**：在不破坏现有功能的前提下调整 UI 布局
- **常量集成**：与现有常量系统的无缝集成方法
- **用户体验设计**：场景化预设选项的设计思路

